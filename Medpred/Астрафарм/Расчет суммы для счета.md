Астрафарм -- это головная боль.

# Из чего состоит оплата

Есть уговор с Астрафармом, что они поделили пользователей на Постоянных и Временных. Временные пользователи могут заходить грубо говоря раз в месяц и Астрафарм не хотят платить полный тариф за таких юзеров.

Постоянные юзеры находятся в группах:

- (2) Администраторы
- (3) ВВ
- (4) РМ
- (7) ТП

Временные юзеры -- все остальные группы:

- (5) Руководители
- (6) Аудиторы

Оплата так же состоит из двух частей:

- Фиксированная за Постоянных пользователей на следующий период
- Доплата за изменение количества активных пользователей за текущий период
- Плавающая за Временных пользователей за текущий период

# Расчет оплаты

## Вводные данные

- Считаем сумму для счета на `Октябрь 2025г`
- День, когда считаем - `24 сентября 2025`
- Текущий период для расчета доплаты за Сентябрь: `с 25 августа по 23 сентября включительно`
- Прошлый период был: `с 28 июля по 24 августа включительно`
- Стоимость юзера в сутки:
	- Авг:  74,1935 р (2300 / 31 день)
	- Сент: 76,6667 р (2300 / 30 дней)
- Тариф 2300р за юзера в месяц
- На 23 сентября:
	- Постоянных юзеров: 33
	- Временных юзеров: 8
	- Итого: 41 юзер

## За постоянных юзеров

Оплата за постоянных юзеров идет на месяц вперед (количество юзеров в день расчета умножается на тариф за юзера). Рассчитывается по обычному алгоритму и состоит из следующих составляющих:

- Тариф на следующий месяц
- Доплата за текущий период

Так как период начинается не первого числа, а ближе к концу месяца, то можно считать доплату за весь период целиком, а не делить его на доплату за остаток прошлого месяца и доплату за текущий месяц.

Дельта юзеров вычисляется через запрос напрямую в БД клиента в MySQL. Для ручной проверки в Журнале действий нужно выставить фильтры по нужным датам (с 25 августа по 23 сентября), выставить "Тип": "Пользователь", выставить "Действия": "Добавление, Удаление, Редактирование, Восстановление".

Далее, нужно найти все записи со значком "i" ![[Pasted image 20250926152925.png]]

В найденных записях нужно проверить изменение значения поля `status` в столбцах "было" и "стало". Если сменилось `0` на `1`, значит пользователя включили (добавили одного), Если с `0` на `1`, значит пользователя отключили (убрали одного). Действия "Добавление" и "Удаление", соответственно, добавляют и убирают пользователя. Может случиться, что поля `status` нет в столбце "было" или "стало", тогда считаем его за `0`.

Такие изменения выписываются на каждый день и рассчитываются по обычной схеме. Итоговая сумма по всем дням за текущий период является доплатой за постоянных пользователей.

## За временных юзеров

Список временных юзеров можно увидеть если отфильтровать их в списке пользователей по группе "Аудиторы" или "Руководители". Здесь важно также включать уже отключенных пользователей, они не появляются в общем списке (но будут присутствовать в отчетах). Варианты переключателей в списке пользователей:

- Активные + Удаленные
- Неактивные
- Неактивные + Удаленные

Порядок действий:

- В списке пользователей выбираем пользователя
- В Журнале действий выставляем фильтры:
	- Действие: "Открыл CRM"
	- Даты: выставить текущий период (в примере это 25 августа по 23 сентября)
	- В фильтре "Менеджеры" выставляем выбранного пользователя
- Подсчитываем количество дней когда пользователь заходил в CRM и выписываем количество дней в отдельную строку для каждого пользователя. Если заходы в CRM были в разные месяцы, то количество дней не смешиваем и записываем как Х+У

> Здесь важно отметить, что за один день может быть несколько записей о заходе в CRM. Считать нужно ***только дни***, а не количество записей.

- Рассчитываем размер доплаты для этого пользователя:
	- Берем стоимость за юзера в день для нужного месяца, умножаем на количество дней
- Берем следующего временного пользователя и повторяем процесс сначала. Повторяем, пока не закончатся временные пользователи в выбранной группе.
- Проверяем не пропустили ли "отключенных", "удаленных" и "отключенно-удаленных" пользователей в выбранной группе.
- Если ничего не пропустили, то выбираем следующую группу временных пользователей и повторяем процесс.

По завершению выйдет список примерно следующего вида (цифры с потолка):

```txt
Доп. пользователи в июле (с 25 августа по 23 сентября вкл):

ауд	3+3дн	Анохина Ирина 445,14р

ауд	4+11дн	Асадулина Татьяна	1 112,85 р

Итого доплата за доп польз. в сентябре +1 557,99 р
```

## Тариф на следующий месяц за регулярных юзеров

Тариф на следующий месяц берется за количество пользователей на день, предшествующий дню, когда производится расчет оплаты. В примере расчет происходит 24 сентября, значит, количество юзеров берется для 23 сентября (33 человека, см вводные данные). Количество умножается на тариф (2300 рублей за юзера в месяц)

# Расшифровка для счета и цифры для счета

В итоге все доплаты и расчеты сводятся воедино в расшифровку счета и отправляется бухгалтеру, она добавит её в счет.

В счете для Астрафарма должно быть две строки:
- Оплата за постоянных пользователей (75 900р)
- Оплата за дополнительных пользователей (1993,33 + 1990,86 = 3984,19р)

Пример расшифровки (цифры с потолка):

```txt
Детализация счета за октябрь 2025:

Доплата за рег. пользователей
за период с 25 авг по 23 сент вкл.:

05 сентября: +1 польз * 76,6667р * 26дн = +1 993,33р
Итого доплата за сентябрь: +1 993,33р

Тариф на октябрь: 33 рег. польз * 2 300 = 75 900,00р

Доп. пользователи в сентябре
(с 25 августа по 23 сентября вкл):
ауд	0+8 дн	Анохина Ирина		613,33р 
ауд	1+13 дн	Асадулина Татьяна	1 070,86р
ауд	0+1 дн	Литвинова Дарья		76,67р
рук	0+3 дн	Шевцов Виктор		230,00р
Итого доплата за доп польз. в сентябре 1 990,86р

Итого за октябрь: 75 900,00 + 1 993,33 + 1 990,86 = 79 884,19 р

```

# Контроль расчетов

Можно проверить количество постоянных пользователей. Берется количество, которое было в прошлом месяце, прибавляется дельта постоянных пользователей за текущий период, в итоге должно получиться текущее количество постоянных пользователей на день расчета.

Или наоборот, от текущего количества отнять дельту и сверить с количеством за предыдущий период. В примере детализации из прошлого параграфа это 33 пользователя минус "+1" (складываем и вычитаем арифметически, со своими знаками, минус на минус даст плюс), в итоге, в прошлом периоде должно быть 32 пользователя.